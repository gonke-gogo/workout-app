FROM golang:1.21-alpine

# 必要なパッケージをインストール
RUN apk add --no-cache git protobuf-dev

# Airをインストール（ホットリロード用）
# Go 1.21対応のバージョンを指定
RUN go install github.com/cosmtrek/air@v1.49.0

# protoc プラグインをインストール
RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.31.0
RUN go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.3.0

WORKDIR /app

# go.mod と go.sum をコピーして依存関係をダウンロード
COPY go.mod go.sum ./
RUN go mod download

# ソースコードをマウントするので、ここではコピーしない
# 実行時に docker-compose の volumes でマウントされる

EXPOSE 50051

# Airを使ってホットリロード
CMD ["air", "-c", ".air.toml"]

